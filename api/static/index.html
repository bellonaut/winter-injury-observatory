<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Winter Injury Risk & Equity Observatory</title>
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" />
  <link rel="stylesheet" href="/static/css/map.css" />
</head>
<body>
  <main class="site">
    <header class="site-header">
      <div>
        <h1>Urban Winter Injury Risk & Equity Observatory</h1>
        <p>Map-first interface for neighborhood-level winter risk, transparent model outputs, and policy-ready interpretation.</p>
      </div>
      <nav class="actions" aria-label="Primary links">
        <a class="btn primary" href="/docs">Open API Docs</a>
        <a class="btn" href="/health">Health</a>
        <a class="btn" href="/api/info">Metadata</a>
      </nav>
    </header>

    <section class="layout">
      <article class="panel map-panel">
        <div class="map-frame">
          <div id="map" role="region" aria-label="Risk map"></div>

          <section class="map-legend" aria-label="Risk legend">
            <h2>Neighborhood Risk</h2>
            <div class="legend-row"><span class="swatch low"></span> Low</div>
            <div class="legend-row"><span class="swatch medium"></span> Medium</div>
            <div class="legend-row"><span class="swatch high"></span> High</div>
            <div class="legend-row"><span class="swatch critical"></span> Critical</div>
          </section>

          <section class="map-overlays" aria-label="Overlay controls">
            <h2>Overlays</h2>
            <label><input id="toggle-sidewalks" type="checkbox" /> Sidewalk Network</label>
            <label><input id="toggle-winter-routes" type="checkbox" /> Winter Routes</label>
            <label><input id="toggle-trail-closures" type="checkbox" /> Trail Closures</label>
            <label><input id="toggle-elevation-spots" type="checkbox" /> Elevation Spots</label>
          </section>

          <section class="map-context" aria-live="polite">
            <h2>Selected Neighborhood</h2>
            <p class="context-line"><strong>Name:</strong> <span id="selected-neighborhood-name">None</span></p>
            <p id="selected-neighborhood-risk" class="context-line">Hover or click a neighborhood to inspect risk details.</p>
          </section>

          <section class="map-timeline" aria-label="Timeline controls">
            <div class="timeline-head">
              <p class="timeline-title">24h timeline sweep</p>
              <button id="timeline-play" class="btn" type="button">Play 24h</button>
            </div>
            <div class="timeline-row">
              <span>Now</span>
              <input id="hour-offset" type="range" min="0" max="23" value="0" />
              <output id="hour-offset-label" for="hour-offset">+0h</output>
            </div>
          </section>
        </div>

        <div class="map-footer">
          <section class="subpanel" aria-live="polite">
            <h3>Top 3 Risk Neighborhoods</h3>
            <ul id="top-risk-list">
              <li>Loading neighborhood risk rankings...</li>
            </ul>
          </section>
          <section class="subpanel">
            <h3>Map Config</h3>
            <p id="map-config-summary">Loading dataset IDs...</p>
            <details>
              <summary>Show raw map layer payload</summary>
              <pre id="map-raw-output" class="codebox">{}</pre>
            </details>
          </section>
        </div>
      </article>

      <aside class="panel side-panel">
        <section class="card">
          <h2>Scenario Controls</h2>
          <div class="form-grid">
            <div class="full">
              <label for="token">Demo Token</label>
              <input id="token" type="password" placeholder="Paste DEMO_API_TOKEN once" />
            </div>
            <div>
              <label for="temperature">Temperature (C)</label>
              <input id="temperature" type="number" step="0.1" value="-15.5" />
            </div>
            <div>
              <label for="wind_speed">Wind Speed (km/h)</label>
              <input id="wind_speed" type="number" step="0.1" value="25" />
            </div>
            <div>
              <label for="wind_chill">Wind Chill (C)</label>
              <input id="wind_chill" type="number" step="0.1" value="-28" />
            </div>
            <div>
              <label for="precipitation">Precipitation (mm)</label>
              <input id="precipitation" type="number" step="0.1" value="2.5" />
            </div>
            <div>
              <label for="snow_depth">Snow Depth (cm)</label>
              <input id="snow_depth" type="number" step="0.1" value="30" />
            </div>
            <div>
              <label for="hour">Hour</label>
              <input id="hour" type="number" min="0" max="23" value="8" />
            </div>
            <div>
              <label for="day_of_week">Day Of Week</label>
              <input id="day_of_week" type="number" min="0" max="6" value="1" />
            </div>
            <div>
              <label for="month">Month</label>
              <input id="month" type="number" min="1" max="12" value="1" />
            </div>
            <div class="full">
              <label for="neighborhood">Neighborhood</label>
              <input id="neighborhood" type="text" value="Downtown" />
            </div>
            <div>
              <label for="ses_index">SES Index (0-1)</label>
              <input id="ses_index" type="number" min="0" max="1" step="0.01" value="0.45" />
            </div>
            <div>
              <label for="infrastructure_quality">Infrastructure Quality (0-1)</label>
              <input id="infrastructure_quality" type="number" min="0" max="1" step="0.01" value="0.70" />
            </div>
          </div>
          <div class="controls">
            <button id="update-map" class="btn" type="button">Update Map</button>
            <button id="load-commute-scenario" class="btn" type="button">Load Commute Scenario</button>
            <button id="run-predict" class="btn primary" type="button">Run API Prediction</button>
          </div>
          <p id="status-text" class="status">Initializing map...</p>
        </section>

        <section class="card">
          <h2>Safest Corridor</h2>
          <div class="form-grid">
            <div class="full">
              <label for="route-from-neighborhood">From Neighborhood</label>
              <select id="route-from-neighborhood">
                <option value="">Select origin</option>
              </select>
            </div>
            <div class="full">
              <label for="route-to-neighborhood">To Neighborhood</label>
              <select id="route-to-neighborhood">
                <option value="">Select destination</option>
              </select>
            </div>
            <div class="full">
              <label for="compare-hour-offset">Compare Hour Offset</label>
              <input id="compare-hour-offset" type="number" min="0" max="23" value="6" />
            </div>
          </div>
          <div class="controls">
            <button id="run-corridor-route" class="btn" type="button">Run Safest Corridor</button>
            <button id="run-corridor-compare" class="btn" type="button">Compare Current vs Hour</button>
          </div>
          <p id="corridor-status" class="status">Choose start and end neighborhoods.</p>
          <p id="corridor-summary" class="context-line">Corridor results will appear here after route computation.</p>
          <p id="corridor-compare-summary" class="context-line">Compare mode summary will appear here.</p>
          <ul id="corridor-hops" class="notes">
            <li>Corridor hop ranks and risk levels will be listed here.</li>
          </ul>
          <details>
            <summary>Show raw corridor response</summary>
            <pre id="corridor-raw-output" class="codebox">{}</pre>
          </details>
        </section>

        <section class="card">
          <h2>Risk Interpretation</h2>
          <span id="risk-pill" class="pill low">Awaiting Input</span>
          <p id="result-hero" class="result-hero">Run API prediction to generate narrative guidance.</p>

          <div class="meter-shell">
            <div class="meter-track">
              <div id="meter-fill" class="meter-fill"></div>
            </div>
          </div>

          <div class="risk-line">
            <strong id="probability-label">Probability: --</strong>
            <span id="prediction-label">Prediction: --</span>
          </div>

          <p id="narrative" class="context-line">Model guidance will appear after running /predict with bearer token auth.</p>

          <ul id="recommendations" class="notes">
            <li>Use this as operational planning support, not clinical truth.</li>
            <li>Compare map and API outputs for calibration transparency.</li>
            <li>Validate with local observations before intervention.</li>
          </ul>

          <details>
            <summary>Show raw prediction response</summary>
            <pre id="raw-output" class="codebox">{}</pre>
          </details>
        </section>
      </aside>
    </section>
  </main>

  <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
  <script type="module" src="/static/js/map-app.js"></script>
</body>
</html>
